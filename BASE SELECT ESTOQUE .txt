--TABELA PCENDERECO:
SELECT CODFILIAL, TIPOENDER, CODENDERECO, NIVEL, SITUACAO, BLOQUEIO, STATUS FROM PCENDERECO WHERE CODFILIAL IN (1,2,3,4);



--TABELA PCESTENDERECO:
SELECT CODENDERECO, CODPROD, QT, QTBLOQUEADA, QTPENDENTRADA, QTPENDSAIDA FROM PCESTENDERECO;



--TABELA PCPRODUT:
SELECT CODAUXILIAR, CODFORNEC, CODPROD, CUSTOREP, DESCRICAO, QTUNITCX FROM PCPRODUT; 



--TABELA PCFORNEC:
SELECT CODFORNEC, FORNECEDOR FROM PCFORNEC;




--TABELA PCEST:
SELECT
    p.CODFILIAL,
    p.CODPROD,
    pc.DESCRICAO AS DESCRICAO_PRODUTO,
    p.CUSTOREAL,
    p.QTBLOQUEADA,
    p.QTINDENIZ,
    p.QTRESERV,
    p.QTEST,
    p.QTESTGER,
    p.QTPEDIDA,
    p.QTGIRODIA,
    COALESCE(m.QT_ENTRADA, 0) AS QT_ENTRADA,
    COALESCE(m.QT_SAIDA, 0) AS QT_SAIDA,
    COALESCE(m.QT_SAIDA / NULLIF(m.CONTADOR, 0), 0) AS MEDIA_SAIDA
FROM
    PCEST p
LEFT JOIN pcprodut pc ON p.CODPROD = pc.CODPROD
LEFT JOIN (
    SELECT
        codfilial,
        codprod,
        SUM(CASE WHEN CODOPER = 'S' THEN QT ELSE 0 END) AS QT_Saida,
        SUM(CASE WHEN CODOPER = 'E' THEN QT ELSE 0 END) AS QT_Entrada,
        COUNT(CASE WHEN CODOPER = 'S' THEN 1 ELSE NULL END) AS CONTADOR
    FROM
        pcmov
    WHERE
        codfilial IN (1, 2, 3, 4)
        AND dtmov BETWEEN ADD_MONTHS(SYSDATE, -12) AND SYSDATE
    GROUP BY
        codfilial,
        codprod
) m ON p.CODFILIAL = m.codfilial AND p.CODPROD = m.codprod
WHERE
    p.CODFILIAL IN (1, 2, 3, 4)
    AND p.QTESTGER > 0;
